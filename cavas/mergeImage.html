<!DOCTYPE html>
<html>
<head>
	<title>合成图片</title>
	<meta name="viewport" content="width=device-width" />
	<meta charset="utf-8">
	<style>
		*{margin: 0}
		.frame{
		    width: 300px;
		    height: 360px;
		    margin: 0 auto 0.4rem;
			border: 1px solid black;
			position: relative;
			overflow: hidden;
		}
		#cover{
			z-index: 2;
			position: absolute;
			top: 0;
			left: 0;
			width: 95%;
			transform: translate3d(5px, 5px, 0);
		}
		#pic{
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
		}
		#show{
			text-align: center;
		}
	</style>
</head>
<body>
	<div class="frame" id="frame">
		<img id="cover" src="../images/word.png" alt="">
		<img id="pic" src="../images/1.jpg" alt="">
	</div>
	<button id="mergeBtn">合成图片</button>
	<div id="show"></div>
	<script src="../hammer/js/hammer.js"></script>
	<script>
		var moveHammer = null;
		var posX = 0;
		var posY = 0;
		var lastPosX = 0;
		var lastPosY = 0;
		var transform = {
	        translate: { x: lastPosX, y: lastPosY },
	        scale: 1,
	        angle: 0,
	        rx: 0,
	        ry: 0,
	        rz: 0
	    };
	    var $frame = document.querySelector('#frame');
	    var $cover = document.querySelector('#cover');
	    var $pic = document.querySelector('#pic');
		window.onload = function() {
			document.querySelector('#frame').addEventListener('touchmove', function(evt) {
	          if(!evt._isScroller) {
	            evt.preventDefault();
	          }
	        });
			DragImage();
			document.querySelector('#mergeBtn').onclick = function(){
				console.log('fjkd');
			    var canvas = document.createElement('canvas');
			    canvas.width = $frame.offsetWidth;//CSS中定义了画布是580
			    canvas.height = $frame.offsetHeight;

			    var ctx = canvas.getContext('2d');
			    ctx.fillStyle = '#FFF';//绘制背景色
			    ctx.fillRect(0,0,canvas.width,canvas.height);
			    var pr = 1;
			    var offsetCover = intersect($frame, $cover)
			    var offset = intersect($frame, $pic);
			    ctx.drawImage($pic,  offset.image.x, offset.image.y, offset.image.w, offset.image.h,offset.frame.x * pr, offset.frame.y * pr, offset.frame.w * pr, offset.frame.h * pr);
			    ctx.restore();
			    ctx.drawImage($cover,  offsetCover.image.x, offsetCover.image.y, offsetCover.image.w, offsetCover.image.h,offsetCover.frame.x * pr, offsetCover.frame.y * pr, offsetCover.frame.w * pr, offsetCover.frame.h * pr);
			    ctx.restore();
			    var base64 = canvas.toDataURL('image/jpeg');
			    //合成的图片
			    document.querySelector('#show').innerHTML = '<img src="'+base64+'">'
			}
		}
		var initScale = 1;
		var objImage = document.querySelector('#pic');


		function DragImage(){

			var mc = new Hammer.Manager(document.querySelector('#frame'));
			mc.add(new Hammer.Pan({ threshold: 0, pointers: 0 }));
			mc.add(new Hammer.Rotate({ threshold: 0 })).recognizeWith(mc.get('pan'));
			mc.add(new Hammer.Pinch({ threshold: 0 })).recognizeWith([mc.get('pan'), mc.get('rotate')]);

			mc.on("panstart panmove panend", onPan);
			mc.on("rotatestart rotatemove", onRotate);
			mc.on("pinchstart pinchmove", onPinch);
		}
		function onPan(ev){
			ev.preventDefault(); //取消事件的默认动画
			if(ev.type == 'panend'){
		    	console.log('djfdk');
		    	lastPosX += ev.deltaX;
		    	lastPosY += ev.deltaY;
		    	return;
		    }
			transform.translate = {
		        x: lastPosX + ev.deltaX,
		        y: lastPosY + ev.deltaY
		    };
			updateElementTransform(objImage);
		}
		var initAngle = 0;
		function onRotate(ev){
		    if(ev.type == 'rotatestart') {
		        initAngle = transform.angle || 0;
		    }

		    transform.rz = 1;
		    transform.angle = initAngle + ev.rotation;
		    updateElementTransform(objImage);
		}
		function onPinch(ev){
			if(ev.type == 'pinchstart') {
		        initScale = transform.scale || 1;
		    }

		    transform.scale = initScale * ev.scale;
		    updateElementTransform(objImage);
		}
		function updateElementTransform(el) {
		    var value = [
		        'translate3d(' + transform.translate.x + 'px, ' + transform.translate.y + 'px, 0)',
		        'scale(' + transform.scale + ', ' + transform.scale + ')',
		        'rotate3d('+ transform.rx +','+ transform.ry +','+ transform.rz +','+  transform.angle + 'deg)'
		    ];

		    value = value.join(" ");
		    el.style.webkitTransform = value;
		    el.style.mozTransform = value;
		    el.style.transform = value;
		}


		function intersect($frame, $img) {
	        var imgX = 0, imgY = 0, imgW = 0, imgH = 0;
	        var frmX = 0, frmY = 0;
	        var imgOffset, frmOffset;
	        var left, right, top, bottom;
	        console.log($img.style.transform)
	        var translate = $img.style.transform.replace(/[^0-9\-,]/g,'').split(',');
	        console.log(translate);
	        imgOffset = {//图片的偏移对象
	        	left: 0,
	        	top: 0,
	        	width: $img.offsetWidth,
	        	height: $img.offsetHeight
	        }
	        frmOffset = {//画框的偏移对象
	        	left: 0,
	        	top: 0,
	        	width: $frame.offsetWidth,
	        	height: $frame.offsetHeight	        	
	        }
	        left = imgOffset.left - frmOffset.left;//图片到边框左边的距离 去除1px的边框
	        right = left + imgOffset.width;//画框模型是border-box，所以图片宽度需要减去边框的宽度 就是574
	        top = imgOffset.top - frmOffset.top;//图片到边框上边的距离
	        bottom = top + imgOffset.height;

	        //图片在画框内
	        if(!(right <= 0 || left >= frmOffset.width || bottom <= 0 || top >= frmOffset.height)) {
	            if(left < 0) {
	                imgX = -left;
	                frmX = 0;
	                imgW = (right < frmOffset.width) ? right : frmOffset.width;
	            } else {
	                imgX = 0;
	                frmX = left;
	                imgW = (right < frmOffset.width ? right : frmOffset.width) - left;
	            }

	            if(top < 0) {
	                imgY = -top;
	                frmY = 0;
	                imgH = (bottom < frmOffset.height) ? bottom : frmOffset.height;
	            } else {
	                imgY = 0;
	                frmY = top;
	                imgH = ((bottom < frmOffset.height) ? bottom : frmOffset.height) - top;

	            }
	        }
	        var ratio = getImgNaturalDimensions($img)[0] / $img.offsetWidth;//图片真实宽度 与 图片CSS宽度
	        console.log(ratio)
	        //图片的实际高度不能低于计算后的高度 否则iphone 5S中就不显示
	        var imageHeight = imgH * ratio;
	        if(getImgNaturalDimensions($img)[1] < imageHeight) {
	            imageHeight = getImgNaturalDimensions($img)[1];
	        }
	        return {
	            frame: {x: frmX, y: frmY, w: (imgW), h: (imgH)},//此处画框是574，而画布是580
	            image: {x: imgX * ratio, y: imgY * ratio, w: imgW * ratio, h: imageHeight}
	        };
	    }
	    function getImgNaturalDimensions(img, callback) {
		    var nWidth, nHeight
		    if (img.naturalWidth) { // 现代浏览器
		        nWidth = img.naturalWidth
		        nHeight = img.naturalHeight
		    } else { // IE6/7/8
		        var imgae = new Image()
		        image.src = img.src
		        image.onload = function() {
		            callback(image.width, image.height)
		        }
		    }
		    return [nWidth, nHeight]
		}
	</script>
</body>
</html>
