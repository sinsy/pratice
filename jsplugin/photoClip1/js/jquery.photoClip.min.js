/* jQuery photoClip v1.10.1 | Relying on the plug-in [iscroll-zoom.js] [hammer.js] [lrz.all.bundle.js] */
!function(t,o){"use strict";"function"==typeof define&&define.amd?define(["jquery","iscroll-zoom","hammer","lrz"],o):"object"==typeof exports?module.exports=o(require("jquery"),require("iscroll-zoom"),require("hammer"),require("lrz")):(t.bjj=t.bjj||{},t.bjj.PhotoClip=o(t.jQuery,t.IScroll,t.Hammer,t.lrz))}(this,function(t,o,e,n){"use strict";function i(o,e){if(!window.FileReader)return void alert("您的浏览器不支持 HTML5 的 FileReader API， 因此无法初始化图片裁剪插件，请更换最新的浏览器！");var n=t.extend({},s,e),i=r(o,n);this.destroy=i.destroy}function r(i,r){function s(){no=!0,so.append(this),w.call(this,to,function(){oo=this.naturalWidth,eo=this.naturalHeight}),w(ao,function(){u()}),X.call(this,this.src)}function l(){var t={zoom:!0,scrollX:!0,scrollY:!0,freeScroll:!0,mouseWheel:!0,wheelAction:"zoom"};vo=new o(ro[0],t)}function u(){ko=0,jo=0,To=0,so.css({width:oo,height:eo}),F(so,ko,jo,To),j(oo,eo),vo.zoom(vo.options.zoomStart),p(oo,eo);var t=.5*(J-oo*vo.options.zoomStart),o=.5*(K-eo*vo.options.zoomStart);vo.scrollTo(t,o)}function p(t,o){ao.css({width:t,height:o}),ro.append(ao),vo.refresh()}function f(){var t=!!navigator.userAgent.match(/mobile/i);if(t){go=new e(ao[0]),go.add(new e.Rotate);var o,n;go.on("rotatemove",function(t){zo||(o=t.rotation,o>180?o-=360:-180>o&&(o+=360),n=o>0?1:0>o?-1:0)}),go.on("rotateend",function(t){zo||Math.abs(o)>30&&(1==n?d(t.center):-1==n&&h(t.center))})}else ao.on("dblclick",function(t){d({x:t.clientX,y:t.clientY})})}function d(t){m(90,t)}function h(t){m(-90,t)}function m(t,o){if(!zo){zo=!0;var e;e=o?x(ao,o.x,o.y):y(ao,ro,.5*J,.5*K);var n,i,r=z(To,e),a=r.x,s=r.y,c=0,l=0,u=0,f=0,d=To+t;90==d||-270==d?(c=a+s,l=s-a,d>To?(u=eo-a-s,f=a-s):To>d&&(u=eo-s-(oo-a),f=a+s-eo),n=eo,i=oo):180==d||-180==d?(c=2*a,l=2*s,d>To?(u=oo-a-(eo-s),f=eo-(a+s)):To>d&&(u=oo-(a+s),f=eo-s-(oo-a)),n=oo,i=eo):270==d||-90==d?(c=a-s,l=a+s,d>To?(u=a+s-oo,f=oo-a-(eo-s)):To>d&&(u=s-a,f=oo-a-s),n=eo,i=oo):(0==d||360==d||-360==d)&&(c=0,l=0,d>To?(u=a-s,f=a+s-oo):To>d&&(u=a+s-eo,f=s-a),n=oo,i=eo),0==To?(ko=0,jo=0):90==To||-270==To?(ko-=a+s,jo-=s-a):180==To||-180==To?(ko-=2*a,jo-=2*s):(270==To||-90==To)&&(ko-=a-s,jo-=a+s),ko=ko.toFixed(2)-0,jo=jo.toFixed(2)-0,F(so,ko,jo,To,a,s),S(so,ko,jo,d,200,function(){zo=!1,To=d%360,ko+=c+u,jo+=l+f,ko=ko.toFixed(2)-0,jo=jo.toFixed(2)-0,F(so,ko,jo,To),vo.scrollTo(vo.x-u*vo.scale,vo.y-f*vo.scale),j(n,i),vo.scale<vo.options.zoomMin&&vo.zoom(vo.options.zoomMin),p(n,i)})}}function g(){mo=document.createElement("canvas")}function v(){if(!no)return void alert("亲，当前没有图片可以裁剪!");var t=y(ao,ro),o=vo.scale,e=mo.getContext("2d");e.clearRect(0,0,mo.width,mo.height),e.save(),N&&V?(mo.width=N,mo.height=V,e.scale(N/J*o,V/K*o)):(mo.width=J/o,mo.height=K/o),e.translate(ko-t.x/o,jo-t.y/o),e.rotate(To*Math.PI/180),e.drawImage(to[0],0,0),e.restore();try{var n=mo.toDataURL(O,1)}catch(i){throw new Error("截图失败！当前图片源文件可能存在跨域问题，请确保图片与应用同源。如果您是在本地环境下执行本程序，请更换至服务器环境。")}co.css("background-image","url("+n+")"),Z.call(to[0],n)}function b(){w(io,function(){bo=io.width(),yo=io.height(),Q&&(J=bo/100*parseFloat(Q),$||(K=J/G)),$&&(K=yo/100*parseFloat($),Q||(J=K*G)),ro.css({width:J,height:K,"margin-left":-J/2,"margin-top":-K/2}),lo.css({"margin-right":J/2,"margin-top":-K/2,"margin-bottom":-K/2}),uo.css({"margin-left":J/2,"margin-top":-K/2,"margin-bottom":-K/2}),po.css({"margin-bottom":K/2}),fo.css({"margin-top":K/2}),ho.css({width:J,height:K,"margin-left":-J/2-1,"margin-top":-K/2-1})})}function y(t,o,e,n){e=e||0,n=n||0;var i,r;return w(t,function(){i=t.offset()}),w(o,function(){r=o.offset()}),{x:r.left-i.left+e,y:r.top-i.top+n}}function x(t,o,e){o=o||0,e=e||0;var n;return w(t,function(){n=t.offset()}),{x:o+wo.scrollLeft()-n.left,y:e+wo.scrollTop()-n.top}}function w(o,e){var n=t();t.each(o,function(o,e){for(var i,r=t(e),a=r.parents().addBack().filter(":hidden"),o=0;o<a.length&&r.is(":hidden");o++)i=a.eq(o),"none"==i.css("display")&&(n=n.add(i.show()))}),"function"==typeof e&&e.call(this),n.hide()}function z(t,o){var e=vo.scale,n={};return 0==t?(n.x=o.x/e,n.y=o.y/e):90==t||-270==t?(n.x=o.y/e,n.y=eo-o.x/e):180==t||-180==t?(n.x=oo-o.x/e,n.y=eo-o.y/e):(270==t||-90==t)&&(n.x=oo-o.y/e,n.y=o.x/e),n}function k(t,o,e,n){var i=t/e,r=o/n;return i>r?i:r}function j(t,o){vo.options.zoomMin=k(J,K,t,o),vo.options.zoomMax=Math.max(1,vo.options.zoomMin),vo.options.zoomStart=Math.min(vo.options.zoomMax,k(bo,yo,t,o))}function T(){to&&to.length&&(to.remove(),delete to[0])}function M(o){T(),to=t("<img>").css({"user-select":"none","pointer-events":"none"}),to.on("load",s),to.attr("src",o)}function F(t,o,e,n,i,r){i=i||0,r=r||0;var a={};a[c+"transform"]="translateZ(0) translate("+o+"px,"+e+"px) rotate("+n+"deg)",a[c+"transform-origin"]=i+"px "+r+"px",t.css(a)}function S(t,o,e,n,i,r){t.css(c+"transform"),t.css(c+"transition",c+"transform "+i+"ms"),t.one(a,function(){t.css(c+"transition",""),r.call(this)}),t.css(c+"transform","translateZ(0) translate("+o+"px,"+e+"px) rotate("+n+"deg)")}function L(t){return"[object Array]"===Object.prototype.toString.call(t)}function q(t){var o=t+"";return/%$/.test(o)}function R(){io=t(i).css({"user-select":"none",overflow:"hidden"}),"static"==io.css("position")&&io.css("position","relative"),ro=t("<div class='photo-clip-view'>").css({position:"absolute",left:"50%",top:"50%"}).appendTo(io),ao=t("<div class='photo-clip-moveLayer'>").appendTo(ro),so=t("<div class='photo-clip-rotateLayer'>").appendTo(ao);var o=t("<div class='photo-clip-mask'>").css({position:"absolute",left:0,top:0,width:"100%",height:"100%","pointer-events":"none"}).appendTo(io);lo=t("<div class='photo-clip-mask-left'>").css({position:"absolute",left:0,right:"50%",top:"50%",bottom:"50%",width:"auto","background-color":"rgba(0,0,0,.5)"}).appendTo(o),uo=t("<div class='photo-clip-mask-right'>").css({position:"absolute",left:"50%",right:0,top:"50%",bottom:"50%","background-color":"rgba(0,0,0,.5)"}).appendTo(o),po=t("<div class='photo-clip-mask-top'>").css({position:"absolute",left:0,right:0,top:0,bottom:"50%","background-color":"rgba(0,0,0,.5)"}).appendTo(o),fo=t("<div class='photo-clip-mask-bottom'>").css({position:"absolute",left:0,right:0,top:"50%",bottom:0,"background-color":"rgba(0,0,0,.5)"}).appendTo(o),ho=t("<div class='photo-clip-area'>").css({border:"1px dashed #ddd",position:"absolute",left:"50%",top:"50%"}).appendTo(o),co=t(W),co.length&&co.css({"background-color":"#666","background-repeat":"no-repeat","background-position":"center","background-size":"contain"})}function C(){_.off("change"),_=null,go?(go.off("rotatemove"),go.off("rotateend"),go.destroy(),go=null):ao.off("dblclick"),vo.destroy(),vo=null,io.empty(),io=null,ro=null,ao=null,so=null,co.css({"background-color":"","background-repeat":"","background-position":"","background-size":""}),co=null}var E=r.size,A=r.adaptive,I=r.outputSize,O=r.outputType||"image/jpeg",P=r.file,H=r.source,W=r.view,D=r.ok,U=r.loadStart,X=r.loadComplete,Y=r.loadError,Z=r.clipFinish,B=r.lrzOption;L(E)||(E=[260,260]),L(I)||(I=[0,0]);var Q,$,G,J=E[0]||260,K=E[1]||260,N=Math.max(I[0],0),V=Math.max(I[1],0);L(A)&&(A[0]&&(Q=q(A[0])?A[0]:!1),A[1]&&($=q(A[1])?A[1]:!1),(Q||$)&&(G=J/K)),"jpg"===O?O="image/jpeg":"png"===O&&(O="image/png");var _=t(P);_.length&&(_.attr("accept","image/jpeg, image/x-png, image/gif"),_.on("change",function(){if(this.files.length){var t=this.files[0];if(!/image\/\w+/.test(t.type))return alert("图片格式不正确，请选择正确格式的图片文件！"),!1;var o=new FileReader;o.onprogress=function(t){console.log((t.loaded/t.total*100).toFixed()+"%")},o.onload=function(){n(t,B).then(function(t){M(t.base64)}).catch(function(t){alert("图片处理失败"),Y.call(this,t)})},o.onerror=function(t){alert("图片加载失败"),Y.call(this,t)},o.readAsDataURL(t),U.call(o,t)}}),_.click(function(){this.value=""})),H&&M(H);var to,oo,eo,no,io,ro,ao,so,co,lo,uo,po,fo,ho,mo,go,vo,bo,yo;R(),l(),f(),g();var xo=t(D);xo.length&&xo.click(function(){v()});var wo=t(window);b(),wo.resize(b);var zo,ko,jo,To;return{destroy:C}}var a,s={size:[260,260],adaptive:null,outputSize:[0,0],outputType:"jpg",file:"",source:"",view:"",ok:"",loadStart:function(){},loadComplete:function(){},loadError:function(){},clipFinish:function(){},lrzOption:{}},c="";return function(){var t,o={Webkit:"webkit",Moz:"",O:"o"},e=document.documentElement,n=function(o){return t?t+o:o.toLowerCase()};for(var i in o)if(void 0!==e.style[i+"TransitionProperty"]){c="-"+i.toLowerCase()+"-",t=o[i];break}a=n("TransitionEnd")}(),i});